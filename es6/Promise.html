<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promise</title>
</head>

<body>
  <script>
    // const promise = new Promise(function(resolve, reject) {
    //   // ...
    //   if (true) { // success
    //     resolve(value)
    //   } else {
    //     reject(error)
    //   }
    // })

    function timeout(ms) {
      return new Promise((resolve, reject) => {
        setTimeout(resolve, ms, 'done')
      })
    }
    timeout(100).then(value => {
      console.log(value)
    })

    let promise = new Promise(function (resolve, reject) {
      console.log('Promise')
      resolve()
    })
    promise.then(function () {
      console.log('resolved.')
    })
    console.log('Hi')

    // 加载图片

    // function loadImageAsync(url) {
    //   return new Promise(function(resolve, reject) {
    //     const image = new Image()

    //     image.onload = function () {
    //       resolve(image)
    //     }

    //     image.onerror = function () {
    //       reject(new Error('Could not load image at ' + url))
    //     }

    //     image.url = url
    //   })
    // }

    // Ajax
    const getJSON = function (url) {
      const promise = new Promise(function (resolve, reject) {
        const handler = function () {
          if (this.readyState !== 4) {
            return
          }
          if (this.status === 200) {
            resolve(this.response)
          } else {
            reject(new Error(this.statusText))
          }
        }
        const client = new XMLHttpRequest()
        client.open("GET", url)
        client.onreadystatechange = handler
        client.responseType = "json"
        client.setRequestHeader("Accept", "application/json")
        client.send()
      })
      return promise
    }
    // getJSON("/posts.json").then(function (json) {
    //   console.log("Contents: " + json)
    // }, function (error) {
    //   console.error('error!', error)
    // })

    // getJSON("/post/1.json").then(
    //   post => getJSON(post.commentURL)
    // ).then(
    //   comments => console.log("resolved: ", comments),
    //   err => console.log("rejected: ", err)
    // )

    // p.then((val) => console.log('fulfilled: ', val))
    //   .catch((err) => console.log('rejected: ', err))
    // p.then((val) => console.log('fulfilled: ', val))
    //   .then(null, (err) => console.log('rejected: ', err))

    // finally 实现
    Promise.prototype.finally = function (callback) {
      let P = this.constructor
      return this.then(
        value => P.resolve(callback()).then(() => value),
        reason => P.resolve(callback()).then(() => { throw reason })
      )
    }

    // Generator 与 Promise 结合
    function getFoo () {
      return new Promise(function (resolve, reject) {
        resolve('foo')
      })
    }
    const g = function* () {
      try {
        const foo = yield getFoo()
        console.log(foo)
      } catch (e) {
        console.log(e)
      }
    }
    function run (generator) {
      const it = generator()
      function go (result) {
        if (result.done) return result.value
        return result.value.then(function (value) {
          return go(it.next(value))
        }, function (error) {
          return go(it.throw(error))
        })
      }
      go(it.next())
    }
    run(g)
  </script>
</body>

</html>